<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Innovision AI Chatbot</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background: #f2f2f2;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      header {
        background: #2d6cdf;
        color: white;
        padding: 16px;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
      }

      #chatbox {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .message {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 15px;
        line-height: 1.4;
        word-wrap: break-word;
      }

      .user {
        background-color: #dcf8c6;
        align-self: flex-end;
        border-bottom-right-radius: 0;
      }

      .bot {
        background-color: #ffffff;
        align-self: flex-start;
        border-bottom-left-radius: 0;
      }

      footer {
        display: flex;
        padding: 12px;
        background: #fff;
        border-top: 1px solid #ccc;
      }

      input[type="text"] {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 8px;
        outline: none;
      }

      button {
        margin-left: 10px;
        background-color: #2d6cdf;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      }

      button:hover {
        background-color: #1b4bb1;
      }
    </style>
  </head>
  <body>
    <header>Innovision AI Chatbot</header>
    <div id="chatbox"></div>
    <footer>
      <input type="text" id="input" placeholder="Nh·∫≠p tin nh·∫Øn..." />
      <button onclick="sendMessage()">G·ª≠i</button>
    </footer>

    <script>
      async function loadMessages() {
        const chatbox = document.getElementById("chatbox");
        try {
          const response = await fetch(
            "https://innovisionserver.click/messages/customer/1"
          );
          const messages = await response.json();
          console.log("D·ªØ li·ªáu messages:", messages);

          messages.forEach((message) => {
            const messageClass = message.is_from_customer ? "user" : "bot";
            const div = document.createElement("div");
            div.classList.add("message", messageClass);
            div.textContent = message.content;
            chatbox.appendChild(div);
          });

          chatbox.scrollTop = chatbox.scrollHeight;
        } catch (error) {
          console.error("Error loading messages:", error);
        }
      }

      window.onload = loadMessages;

      document
        .getElementById("input")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter") {
            event.preventDefault(); // NgƒÉn Enter xu·ªëng d√≤ng
            sendMessage(); // G·ªçi h√†m g·ª≠i tin nh·∫Øn
          }
        });

        async function sendMessage() {
    const input = document.getElementById("input");
    const chatbox = document.getElementById("chatbox");
    const userMessage = input.value.trim();
    if (!userMessage) return;

    // Th√™m tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng v√†o khung chat
    const userDiv = document.createElement("div");
    userDiv.classList.add("message", "user");
    userDiv.textContent = userMessage;
    chatbox.appendChild(userDiv);
    input.value = "";

    // Th√™m placeholder "xin ch·ªù 1 t√≠..."
    const botDiv = document.createElement("div");
    botDiv.classList.add("message", "bot");
    botDiv.textContent = "ü§ñ Xin ch·ªù 1 t√≠...";
    chatbox.appendChild(botDiv);
    chatbox.scrollTop = chatbox.scrollHeight;

    try {
      // G·ª≠i log tin nh·∫Øn ng∆∞·ªùi d√πng
      await fetch("https://innovisionserver.click/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          customerId: 1,
          content: userMessage,
          is_from_customer: true
        })
      });

      // G·ª≠i l√™n webhook, timeout sau 5 gi√¢y
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 5000);

      const webhookRes = await fetch("https://innovisioncloud.click/webhook-test/chatbot-webhook", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: userMessage,
          customerId: 1
        }),
        signal: controller.signal
      });

      clearTimeout(timeout);

      let botReply = "Kh√¥ng c√≥ ph·∫£n h·ªìi t·ª´ chatbot.";
      if (webhookRes.ok) {
        const data = await webhookRes.json();
        botReply = data.reply || botReply;
      }

      // Ghi log ph·∫£n h·ªìi bot
      await fetch("https://innovisionserver.click/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          customerId: 1,
          content: botReply,
          is_from_customer: false
        })
      });

      // C·∫≠p nh·∫≠t n·ªôi dung tin nh·∫Øn "xin ch·ªù" th√†nh ph·∫£n h·ªìi th·∫≠t
      botDiv.textContent = botReply;
      chatbox.scrollTop = chatbox.scrollHeight;
    } catch (error) {
      botDiv.textContent = "Kh√¥ng c√≥ ph·∫£n h·ªìi t·ª´ chatbot.";
      console.error("Webhook timeout ho·∫∑c l·ªói kh√°c:", error);
    }
  }</script>
  </body>
</html>
